{% extends 'base.html' %}
{% load static %}
{% load tz %}

{% block content %}
<div class="container py-4" style="max-width: 700px; height: 80vh;">
    <!-- Back to rooms -->
  <div class="mt-3">
    <a href="{% url 'room_list' %}" class="btn btn-link">‚Üê Back to Rooms</a>
  </div>

  <!-- Room Header with Three Dots Dropdown -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="text-primary mb-0">Room: {{ room.name }}</h3>

    <!-- Three dots dropdown -->
    <div class="dropdown">
      <button class="btn btn-light btn-sm" type="button" id="roomMenu" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="bi bi-three-dots"></i> <!-- Bootstrap icon -->
      </button>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="roomMenu">
        <li>
          <a class="dropdown-item text-danger" href="{% url 'delete_room' room.name %}"
             onclick="return confirm('Are you sure you want to delete this room?');">
            Delete Room
          </a>
        </li>
      </ul>
    </div>
  </div>
  <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>

  <!-- Chat container -->
  <div class="card d-flex flex-column" style="height: 100%;">
    <div id="chat-log" class="flex-grow-1 p-3 overflow-auto" style="background: #f0f0f0;">
      {% for msg in messages %}
        <div class="d-flex mb-2 {% if msg.user.username == request.user.username %}justify-content-end{% else %}justify-content-start{% endif %}">
          <div class="p-2 rounded" style="max-width: 70%; background: {% if msg.user.username == request.user.username %}#dcf8c6{% else %}#fff{% endif %}; box-shadow: 0 1px 1px rgba(0,0,0,0.1);">
            <strong>{{ msg.user.username }}</strong><br>
            {{ msg.content }}
            <small class="d-block text-muted text-end" style="font-size: 0.7rem;">
              {{ msg.timestamp|localtime|date:"H:i" }}
            </small>
          </div>
        </div>
      {% empty %}
        <p class="text-center text-muted mt-3">No messages yet.</p>
      {% endfor %}
    </div>

    <!-- Input area -->
    <div class="input-group p-3 border-top">
      <input id="chat-message-input" type="text" class="form-control" placeholder="Type a message..." required>
      <button id="chat-message-submit" class="btn btn-success">Send</button>
    </div>
  </div>

  
</div>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<!-- Bootstrap JS -->
<script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>


<!-- WebSocket Chat JS -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const roomName = "{{ room.name }}";
    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/chat/' + encodeURIComponent(roomName) + '/'
    );

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const chatLog = document.getElementById('chat-log');

        const bubbleDiv = document.createElement('div');
        bubbleDiv.classList.add('d-flex', 'mb-2');
        bubbleDiv.classList.add(data.username === "{{ request.user.username }}" ? 'justify-content-end' : 'justify-content-start');

        const msgContent = document.createElement('div');
        msgContent.classList.add('p-2', 'rounded');
        msgContent.style.maxWidth = '70%';
        msgContent.style.background = data.username === "{{ request.user.username }}" ? '#dcf8c6' : '#fff';
        msgContent.style.boxShadow = '0 1px 1px rgba(0,0,0,0.1)';
        msgContent.innerHTML = `<strong>${data.username}</strong><br>${data.message}
          <small class="d-block text-muted text-end" style="font-size: 0.7rem;">${data.timestamp}</small>`;

        bubbleDiv.appendChild(msgContent);
        chatLog.appendChild(bubbleDiv);

        chatLog.scrollTop = chatLog.scrollHeight;
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.getElementById('chat-message-submit').onclick = function() {
        const input = document.getElementById('chat-message-input');
        if(input.value.trim() !== '') {
            chatSocket.send(JSON.stringify({'message': input.value}));
            input.value = '';
        }
    };

    document.getElementById('chat-message-input').onkeyup = function(e) {
        if(e.keyCode === 13) document.getElementById('chat-message-submit').click();
    };
});
</script>
{% endblock %}
